<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Tickets</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="p-4">
<h2>ðŸ“‹ My Tickets</h2>

<div>
    <label for="filter">Filter by status:</label>
    <select id="filter">
        <option value="">All</option>
        <option value="open">Open</option>
        <option value="in_progress">In Progress</option>
        <option value="closed">Closed</option>
    </select>
</div>

<div id="tickets" class="mt-3"></div>

<script>
    const userEmail = document.cookie.split('; ').find(c => c.startsWith('user_email')).split('=')[1];

    async function loadTickets() {
        const status = document.getElementById('filter').value;
        const res = await fetch(`/api/tickets?email=${userEmail}&status=${status}`);
        const tickets = await res.json();

        const container = document.getElementById('tickets');
        container.innerHTML = '';

        tickets.forEach(t => {
            const div = document.createElement('div');
            div.className = 'ticket-block';
            div.innerHTML = `
          <h4>${t.title}</h4>
          <p>${(t.last_message || '').slice(0, 100)}</p>
          <p><small>Created: ${new Date(t.creation_date).toLocaleString()}</small></p>
          <p><small>Last message: ${t.last_message_date ? new Date(t.last_message_date).toLocaleString() : 'â€”'}</small></p>
          <p><strong>Status: ${t.status}</strong></p>
        `;
            div.onclick = () => window.location.href = `ticket.html?id=${t.id}`;
            container.appendChild(div);
        });
    }

    document.getElementById('filter').addEventListener('change', loadTickets);

    loadTickets();
</script>
</body>
</html>
